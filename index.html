<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Employee Tree (Year × Section × Group)</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- D3.js -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<style>
  body { margin: 0; overflow: auto; background: #f3f4f6; }
  .card {
    transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
  }
  .card:hover {
    z-index: 1000;
    box-shadow: 0 8px 16px rgba(0,0,0,0.25);
  }
  .year-label {
    font-weight: bold;
    font-size: 20px;
  }
  .section-label {
    font-weight: bold;
    font-size: 18px;
  }
</style>
</head>

<body>

<div id="zoom-wrapper" class="relative">
  <div id="container" class="absolute top-0 left-0"></div>
  <svg id="lines" class="absolute top-0 left-0 pointer-events-none"></svg>
</div>

<script>
fetch("./data.json")
  .then(res => res.json())
  .then(data => init(data));

function init(sample) {

  const sections = [
    {name: "Engineer", color: "#4CAF50"},
    {name: "Planner",  color: "#2196F3"},
    {name: "Designer", color: "#FF9800"}
  ];

  const groupsOrder = ["A班","B班","C班","企画班","調整班","背景班","モーション班"];

  const yearHeight = 260;
  const sectionWidth = 500;
  const groupWidth = 160;
  const cardW = 130;
  const cardH = 48;

  const wrapper = document.getElementById("zoom-wrapper");
  const container = document.getElementById("container");
  const svg = d3.select("#lines");

  const years = [...new Set(sample.map(d => d.year))].sort((a,b)=>a-b);

  // --------------------------
  // 年ラベル（縦方向）
  // --------------------------
  years.forEach((year, yi) => {
    const yPos = yi * yearHeight + 40;
    const label = document.createElement("div");
    label.className = "absolute year-label left-4 text-gray-700";
    label.style.top = `${yPos}px`;
    label.textContent = `${year} 年`;
    container.appendChild(label);
  });

  // --------------------------
  // セクションラベル（上）
  // --------------------------
  sections.forEach((sec, si) => {
    const xPos = si * sectionWidth + 150;
    const label = document.createElement("div");
    label.className = "absolute section-label text-gray-800";
    label.style.left = `${xPos}px`;
    label.style.top = `10px`;
    label.textContent = sec.name;
    container.appendChild(label);
  });

  let cardPositions = [];

  // --------------------------
  // カード配置
  // --------------------------
  sections.forEach((sec, si) => {
    years.forEach((year, yi) => {

      const yearPeople = sample.filter(
        d => d.year === year && d.section === sec.name
      );

      const sorted = yearPeople.sort(
        (a,b) => groupsOrder.indexOf(a.group) - groupsOrder.indexOf(b.group)
      );

      sorted.forEach(p => {
        const x = si * sectionWidth + 150 + (groupsOrder.indexOf(p.group) * groupWidth);
        const y = yi * yearHeight + 80;

        const card = document.createElement("div");
        card.className =
          "card absolute bg-white shadow-md rounded-lg px-3 py-2 border cursor-pointer";
        card.style.left = `${x}px`;
        card.style.top = `${y}px`;
        card.style.width = `${cardW}px`;
        card.style.height = `${cardH}px`;
        card.style.borderColor = sec.color;
        card.dataset.year = year;

        card.innerHTML = `
          <div class="font-bold text-gray-800">${p.name}</div>
          <div class="text-xs text-gray-500">${p.group}</div>
        `;

        container.appendChild(card);

        cardPositions.push({ name:p.name, x, y, year, section:sec.name, group:p.group });

        card.addEventListener("mouseenter", ()=>highlightYear(year));
        card.addEventListener("mouseleave", ()=>resetHighlight());
      });
    });
  });

  // --------------------------
  // 線の描画（カード配置完了後）
  // --------------------------
  drawLines();

  function drawLines() {
    svg.selectAll("*").remove(); // 一旦クリア

    cardPositions.forEach(() => {});

    sections.forEach(sec => {
      groupsOrder.forEach(group => {

        const list = cardPositions
          .filter(p => p.section === sec.name && p.group === group)
          .sort((a,b) => a.year - b.year);

        for(let i=0; i<list.length-1; i++){
          svg.append("line")
            .attr("x1", list[i].x + cardW/2)
            .attr("y1", list[i].y + cardH)
            .attr("x2", list[i+1].x + cardW/2)
            .attr("y2", list[i+1].y)
            .attr("stroke", sec.color)
            .attr("stroke-width", 3)
            .attr("opacity", 0.75);
        }
      });
    });
  }

  // --------------------------
  // 同期ホバー
  // --------------------------
  function highlightYear(targetYear){
    document.querySelectorAll(".card").forEach(card=>{
      if(Number(card.dataset.year) === targetYear){
        card.style.transform = "scale(1.2)";
        card.style.zIndex = 999;
        card.style.opacity = "1";
      } else {
        card.style.opacity = "0.3";
        card.style.transform = "scale(0.9)";
      }
    });
  }

  function resetHighlight(){
    document.querySelectorAll(".card").forEach(card=>{
      card.style.opacity = "1";
      card.style.transform = "scale(1)";
      card.style.zIndex = 1;
    });
  }

  // --------------------------
  // コンテンツ幅を動的計算
  // --------------------------
  const maxX = Math.max(...cardPositions.map(p=>p.x)) + cardW + 200;
  const maxY = Math.max(...cardPositions.map(p=>p.y)) + cardH + 200;
  wrapper.style.width = `${maxX}px`;
  wrapper.style.height = `${maxY}px`;

  // --------------------------
  // ズーム（控えめな中央寄せ）
  // --------------------------
  const zoom = d3.zoom()
    .scaleExtent([0.5, 2])
    .on("zoom", ev => {
      wrapper.style.transform = `
        translate(${ev.transform.x}px, ${ev.transform.y}px)
        scale(${ev.transform.k})
      `;
    });

  const initialX = window.innerWidth * 0.25;  // 左 1/4 に寄せる（控えめ寄せ）
  const initialY = 50;

  const selection = d3.select("body");
  selection.call(zoom);

  selection.call(
    zoom.transform,
    d3.zoomIdentity.translate(initialX, initialY).scale(1)
  );
}
</script>
</body>
</html>
